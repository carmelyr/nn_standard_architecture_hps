apiVersion: batch/v1
kind: Job
metadata:
  name: carmely-nn-standard-hps-job-transformer
  namespace: user-carmely-reiska
spec:
  backoffLimit: 10
  completions: 1
  parallelism: 1
  template:
    spec:
      containers:
        - name: carmely-nn-standard-hps-container
          image: ccu-k8s.inf.uni-konstanz.de:32250/carmely.reiska/nn-standard-hps:latest
          command: ["/bin/bash"]
          args:
            - -c
            - >
              set -euxo pipefail &&
              export POD_ID=${RUN_ID##*-} &&
              mkdir -p /abyss/home/results/transformer/$POD_ID &&
              cd /abyss/home/nn_standard_architecture_hps &&
              mkdir -p results &&
              if [ ! -d results/Transformer ]; then cp -r /abyss/home/nn_standard_architecture_hps/results/Transformer results/Transformer; fi &&
              python train_transformer.py &&
              echo "Contents of results/Transformer:" &&
              ls -lh results/Transformer/ &&
              cp -vr results/Transformer/* /abyss/home/results/transformer/$POD_ID/ &&
              echo "Copied files to /abyss/home/results/transformer/$POD_ID:" &&
              ls -lh /abyss/home/results/transformer/$POD_ID/
          env:
            - name: RUN_ID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          resources:
            requests:
              memory: "50Gi"
              cpu: "4"
              nvidia.com/gpu: "1"
            limits:
              memory: "50Gi"
              cpu: "8"
              nvidia.com/gpu: "1"
          volumeMounts:
            - mountPath: /abyss/home
              name: cephfs-home
              readOnly: false
            - mountPath: /abyss/shared
              name: cephfs-shared
              readOnly: false
            - mountPath: /abyss/datasets
              name: cephfs-datasets
              readOnly: true
      imagePullSecrets:
        - name: registry-ro-login
      tolerations:
        - key: "gpumem"
          operator: "Equal"
          value: "40"
          effect: "NoSchedule"
      restartPolicy: Never
      volumes:
        - name: cephfs-home
          hostPath:
            path: /cephfs/abyss/home/carmely-reiska
        - name: cephfs-shared
          hostPath:
            path: /cephfs/abyss/shared
        - name: cephfs-datasets
          hostPath:
            path: /cephfs/abyss/datasets

